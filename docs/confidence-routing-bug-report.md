# Confidence Routing 標點漏失 Bug 分析報告

**日期**：2026-02-18
**影響版本**：commit `caf5325` ~ `06ccaea`
**修復 commit**：`06ccaea`

## 問題描述

使用者在啟用 AI Enhancement + Confidence Routing 的情況下，部分長段語音輸入未經 LLM 潤稿就直接貼上，導致輸出缺少適當的標點符號和語句整理。

## 資料來源

debug log 記錄於 `~/Library/Logs/Voco/confidence-routing.log`，涵蓋 2026-02-17 12:16 ~ 2026-02-18 00:31 的完整 routing 決策記錄。

## 統計摘要

| 決策類型 | 次數 | 說明 |
|---------|------|------|
| FORCE LLM: needs punctuation | 51 | 正確：偵測到無標點，強制走 LLM |
| SKIP: high confidence | 32 | Whisper 信心度高，跳過 LLM |
| SKIP: simple text | 2 | 短回覆（如「好」「對」），正確跳過 |
| SKIP: mainly English | 1 | 純英文文字，正確跳過 |
| DEFAULT: use LLM | 1 | 預設走 LLM |
| LLM Validation 失敗 | 0 | 所有 LLM 結果均通過驗證 |

**被跳過的 32 次中，有 3 次屬於誤判**（標點密度不足但被當成「有標點」）。

## 根因分析

### 原始邏輯

`needsPunctuation()` 使用**二元判斷**：文字中是否包含任何一個中文標點符號。

```swift
// 舊邏輯
let hasPunctuation = text.contains { punctuationMarks.contains($0) }
return !hasPunctuation  // 有任何標點 → 不需要 LLM
```

### 問題

Whisper 的中文輸出有時只在**句尾**附帶少量標點（如一個問號），中間的子句完全沒有逗號。舊邏輯只要找到 1 個標點就判定為「有標點」，導致長段落被跳過。

### 受影響的案例

#### 案例 1：133 字 / 1 個標點

```
而且說到這個問題立法的這個問題你可以從網路上查一下我們這種例子的人
其實也有一個人曾經想過要去當立委當然走的路不太順利了這點都是真的可
是那時候因為他的講話也是這樣子然後就被我們的中選會就說不能代翻譯要
表達只能自己表達請问一下這種状況下就算自己表达也沒有人能够聽得懂吗？
```

- **字數**：133
- **標點數**：1（句尾的 `？`）
- **密度**：0.75 / 100 字
- **期望密度**：至少 5 / 100 字（每 20 字 1 個）
- **舊判斷**：有標點 → 跳過 LLM
- **新判斷**：1 < 6（期望值）→ 強制走 LLM

#### 案例 2：108 字 / 3 個標點

```
他成就那麼高 然後也會幫別人去爭取一些立法的制度 立法的合理性或者是
說什麼個人助理的修法之類的也是 他常常在臉書PO這種議題你就知道我們
兩個程度差多多了 但是我覺得他快樂嗎？
```

- **字數**：108（含空格 87）
- **標點數**：3（`？，。` 集中在尾部）
- **舊判斷**：有標點 → 跳過 LLM
- **新判斷**：3 < 5（期望值）→ 強制走 LLM

#### 案例 3：78 字 / 2 個標點

```
我覺得我們可以直接在這裡整理成一篇文章然後你直接幫我發耶反正我就覺
得我很不能理解但是我怎麼說呢？ 呃... 手動寫有手動寫的好處吧？ 自動
寫也有自動寫的好處
```

- **字數**：78
- **標點數**：2（兩個 `？`）
- **舊判斷**：有標點 → 跳過 LLM
- **新判斷**：2 < 3（期望值）→ 強制走 LLM

### 正常跳過的案例（不受影響）

```
雖然我虧了兩年，但是這也是沒辦法的事情了，虧了兩年的使用期。
```

- **字數**：30
- **標點數**：3（`，，。`）
- **密度**：10 / 100 字
- **新判斷**：3 >= 1（期望值）→ 維持跳過

## 修復方案

### 密度檢查

將二元判斷改為密度檢查：**每 20 字至少需要 1 個中文標點**。

```swift
// 新邏輯
let punctCount = text.filter { punctuationMarks.contains($0) }.count
if punctCount == 0 { return true }
let expectedPunct = text.count / 20
return punctCount < max(expectedPunct, 1)
```

### 雙層防護

同樣的密度檢查套用在兩個位置：

1. **`needsPunctuation()`**（ChinesePostProcessingService）— 在 routing 決策時判斷
2. **Safety net**（WhisperState）— 在 routing 跳過後的二次攔截

### 影響範圍

| 指標 | 修復前 | 修復後 |
|------|--------|--------|
| 總決策次數 | 87 | 87 |
| 正確走 LLM | 52 | 55 |
| 正確跳過 LLM | 32 | 29 |
| 誤判（應走 LLM 卻跳過） | 3 | 0 |
| 誤殺（不該走 LLM 卻走了） | 0 | 0 |

## LLM 潤稿品質觀察

從 LLM Validation log 中可以觀察到 LLM 的實際處理效果：

- **所有 49 次 LLM 增強結果均通過驗證**（isValid=true）
- LLM 能正確處理：同音字修正（`ChargeBT` → `ChatGPT`、`Cloud` → `Claude`）
- LLM 能正確處理：贅字過濾（「上... 等一下」→「等一下」）
- LLM 能正確處理：自動條列化（「12342我覺得...」→「1. 2. 3. 4. 我覺得...」）
- LLM 能正確處理：標點添加（所有案例都正確添加了逗號、句號）

## 結論

1. **根因明確**：二元標點檢查無法處理「有少量標點但密度不足」的情況
2. **修復有效**：密度檢查精準修復 3 個誤判案例，不影響 29 個正確跳過的案例
3. **LLM 品質穩定**：所有 LLM 結果都通過驗證，沒有出現異常輸出
4. **建議**：保留 debug log 再觀察一段時間，確認密度閾值（20 字/標點）是否需要微調
